/**
 * App state store using Zustand
 * Simplified: Uses Filter and TradeIdea objects directly, no legacy settings
 * - Portions generated by AI
 */

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { OptionResult, Filter, TradeIdea } from '@/types';

// Screening progress state
export interface ScreeningProgress {
  isActive: boolean;
  currentSymbol: string | null;
  completedCount: number;
  totalCount: number;
  startTime: number | null;
}

interface AppState {
  // Filters
  systemFilters: Filter[];
  userFilters: Filter[];
  selectedFilter: Filter | null;
  defaultFilterId: string | null;
  setFilters: (system: Filter[], user: Filter[], defaultId: string | null) => void;
  selectFilter: (filter: Filter) => void;
  addUserFilter: (filter: Filter) => void;
  updateUserFilter: (filter: Filter) => void;
  removeUserFilter: (filterId: string) => void;

  // Trade Ideas
  systemTradeIdeas: TradeIdea[];
  userTradeIdeas: TradeIdea[];
  selectedTradeIdea: TradeIdea | null;
  defaultTradeIdeaId: string | null;
  setTradeIdeas: (system: TradeIdea[], user: TradeIdea[], defaultId: string | null) => void;
  selectTradeIdea: (idea: TradeIdea) => void;
  addUserTradeIdea: (idea: TradeIdea) => void;
  updateUserTradeIdea: (idea: TradeIdea) => void;
  removeUserTradeIdea: (ideaId: string) => void;

  // Loading states
  filtersLoading: boolean;
  tradeIdeasLoading: boolean;
  setFiltersLoading: (loading: boolean) => void;
  setTradeIdeasLoading: (loading: boolean) => void;

  // Screening results
  results: Record<string, OptionResult[]>;
  setResults: (results: Record<string, OptionResult[]>) => void;
  clearResults: () => void;
  appendResult: (symbol: string, options: OptionResult[]) => void;

  // Screening progress
  screeningProgress: ScreeningProgress | null;
  setScreeningProgress: (progress: Partial<ScreeningProgress> | null) => void;
  startScreening: (totalCount: number) => void;
  updateScreeningSymbol: (symbol: string) => void;
  incrementProgress: () => void;
  stopScreening: () => void;
  stopRequested: boolean;
  requestStop: () => void;

  // UI state
  selectedSymbol: string;
  setSelectedSymbol: (symbol: string) => void;
  selectedView: string;
  setSelectedView: (view: string) => void;
  isScreening: boolean;
  setIsScreening: (screening: boolean) => void;
  usedYahooFallback: boolean;
  setUsedYahooFallback: (used: boolean) => void;

  // Sidebar
  sidebarOpen: boolean;
  setSidebarOpen: (open: boolean) => void;
  toggleSidebar: () => void;

  // Reset state (for logout)
  resetState: () => void;
}

export const useAppStore = create<AppState>()(
  persist(
    (set) => ({
      // Filters
      systemFilters: [],
      userFilters: [],
      selectedFilter: null,
      defaultFilterId: null,
      setFilters: (system, user, defaultId) =>
        set({ systemFilters: system, userFilters: user, defaultFilterId: defaultId }),
      selectFilter: (filter) =>
        set({ selectedFilter: filter }),
      addUserFilter: (filter) =>
        set((state) => ({
          userFilters: [...state.userFilters, filter],
        })),
      updateUserFilter: (filter) =>
        set((state) => ({
          userFilters: state.userFilters.map((f) =>
            f.id === filter.id ? filter : f
          ),
          selectedFilter:
            state.selectedFilter?.id === filter.id ? filter : state.selectedFilter,
        })),
      removeUserFilter: (filterId) =>
        set((state) => ({
          userFilters: state.userFilters.filter((f) => f.id !== filterId),
          selectedFilter:
            state.selectedFilter?.id === filterId ? null : state.selectedFilter,
        })),

      // Trade Ideas
      systemTradeIdeas: [],
      userTradeIdeas: [],
      selectedTradeIdea: null,
      defaultTradeIdeaId: null,
      setTradeIdeas: (system, user, defaultId) =>
        set({ systemTradeIdeas: system, userTradeIdeas: user, defaultTradeIdeaId: defaultId }),
      selectTradeIdea: (idea) =>
        set((state) => ({
          selectedTradeIdea: idea,
          // Update selected symbol if current one is not in new symbols
          selectedSymbol: idea.symbols.includes(state.selectedSymbol)
            ? state.selectedSymbol
            : idea.symbols[0] || state.selectedSymbol,
        })),
      addUserTradeIdea: (idea) =>
        set((state) => ({
          userTradeIdeas: [...state.userTradeIdeas, idea],
        })),
      updateUserTradeIdea: (idea) =>
        set((state) => ({
          userTradeIdeas: state.userTradeIdeas.map((i) =>
            i.id === idea.id ? idea : i
          ),
          selectedTradeIdea:
            state.selectedTradeIdea?.id === idea.id ? idea : state.selectedTradeIdea,
        })),
      removeUserTradeIdea: (ideaId) =>
        set((state) => ({
          userTradeIdeas: state.userTradeIdeas.filter((i) => i.id !== ideaId),
          selectedTradeIdea:
            state.selectedTradeIdea?.id === ideaId ? null : state.selectedTradeIdea,
        })),

      // Loading states
      filtersLoading: false,
      tradeIdeasLoading: false,
      setFiltersLoading: (loading) => set({ filtersLoading: loading }),
      setTradeIdeasLoading: (loading) => set({ tradeIdeasLoading: loading }),

      // Results
      results: {},
      setResults: (results) => set({ results }),
      clearResults: () => set({ results: {} }),
      appendResult: (symbol, options) =>
        set((state) => ({
          results: { ...state.results, [symbol]: options },
        })),

      // Screening progress
      screeningProgress: null,
      setScreeningProgress: (progress) =>
        set((state) => ({
          screeningProgress: progress
            ? { ...state.screeningProgress, ...progress } as ScreeningProgress
            : null,
        })),
      startScreening: (totalCount) =>
        set({
          screeningProgress: {
            isActive: true,
            currentSymbol: null,
            completedCount: 0,
            totalCount,
            startTime: Date.now(),
          },
          stopRequested: false,
          isScreening: true,
          results: {},
        }),
      updateScreeningSymbol: (symbol) =>
        set((state) => ({
          screeningProgress: state.screeningProgress
            ? { ...state.screeningProgress, currentSymbol: symbol }
            : null,
        })),
      incrementProgress: () =>
        set((state) => ({
          screeningProgress: state.screeningProgress
            ? {
                ...state.screeningProgress,
                completedCount: state.screeningProgress.completedCount + 1,
              }
            : null,
        })),
      stopScreening: () =>
        set({
          screeningProgress: null,
          isScreening: false,
          stopRequested: false,
        }),
      stopRequested: false,
      requestStop: () => set({ stopRequested: true }),

      // UI state
      selectedSymbol: 'AAPL',
      setSelectedSymbol: (symbol) => set({ selectedSymbol: symbol }),
      selectedView: 'Summary',
      setSelectedView: (view) => set({ selectedView: view }),
      isScreening: false,
      setIsScreening: (screening) => set({ isScreening: screening }),
      usedYahooFallback: false,
      setUsedYahooFallback: (used) => set({ usedYahooFallback: used }),

      // Sidebar
      sidebarOpen: true,
      setSidebarOpen: (open) => set({ sidebarOpen: open }),
      toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),

      // Reset state (for logout)
      resetState: () =>
        set({
          selectedFilter: null,
          selectedTradeIdea: null,
          results: {},
          screeningProgress: null,
          isScreening: false,
          stopRequested: false,
        }),
    }),
    {
      name: 'put-options-screener',
      // Only persist UI preferences
      partialize: (state) => ({
        sidebarOpen: state.sidebarOpen,
      }),
    }
  )
);
