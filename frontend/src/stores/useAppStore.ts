/**
 * App state store using Zustand
 * - Portions generated by AI
 */

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { UserSettings, OptionResult } from '@/types';

// Default settings matching config.json
const DEFAULT_SETTINGS: UserSettings = {
  symbols: ['AAPL', 'MSFT', 'GOOGL', 'SPY', 'QQQ'],
  max_dte: 45,
  min_dte: 15,
  min_volume: 10,
  min_open_interest: 10,
  min_annualized_return: 20.0,
  max_assignment_probability: 20,
};

// Screening progress state
export interface ScreeningProgress {
  isActive: boolean;
  currentSymbol: string | null;
  completedCount: number;
  totalCount: number;
  startTime: number | null;
}

interface AppState {
  // Settings
  settings: UserSettings;
  setSettings: (settings: Partial<UserSettings>) => void;
  resetSettings: () => void;

  // Screening results
  results: Record<string, OptionResult[]>;
  setResults: (results: Record<string, OptionResult[]>) => void;
  clearResults: () => void;
  appendResult: (symbol: string, options: OptionResult[]) => void;

  // Screening progress
  screeningProgress: ScreeningProgress | null;
  setScreeningProgress: (progress: Partial<ScreeningProgress> | null) => void;
  startScreening: (totalCount: number) => void;
  updateScreeningSymbol: (symbol: string) => void;
  incrementProgress: () => void;
  stopScreening: () => void;
  stopRequested: boolean;
  requestStop: () => void;

  // UI state
  selectedSymbol: string;
  setSelectedSymbol: (symbol: string) => void;
  selectedView: string;
  setSelectedView: (view: string) => void;
  isScreening: boolean;
  setIsScreening: (screening: boolean) => void;
  usedYahooFallback: boolean;
  setUsedYahooFallback: (used: boolean) => void;

  // Sidebar
  sidebarOpen: boolean;
  setSidebarOpen: (open: boolean) => void;
  toggleSidebar: () => void;
}

export const useAppStore = create<AppState>()(
  persist(
    (set) => ({
      // Settings
      settings: DEFAULT_SETTINGS,
      setSettings: (newSettings) =>
        set((state) => ({
          settings: { ...state.settings, ...newSettings },
        })),
      resetSettings: () => set({ settings: DEFAULT_SETTINGS }),

      // Results
      results: {},
      setResults: (results) => set({ results }),
      clearResults: () => set({ results: {} }),
      appendResult: (symbol, options) =>
        set((state) => ({
          results: { ...state.results, [symbol]: options },
        })),

      // Screening progress
      screeningProgress: null,
      setScreeningProgress: (progress) =>
        set((state) => ({
          screeningProgress: progress
            ? { ...state.screeningProgress, ...progress } as ScreeningProgress
            : null,
        })),
      startScreening: (totalCount) =>
        set({
          screeningProgress: {
            isActive: true,
            currentSymbol: null,
            completedCount: 0,
            totalCount,
            startTime: Date.now(),
          },
          stopRequested: false,
          isScreening: true,
          results: {},
        }),
      updateScreeningSymbol: (symbol) =>
        set((state) => ({
          screeningProgress: state.screeningProgress
            ? { ...state.screeningProgress, currentSymbol: symbol }
            : null,
        })),
      incrementProgress: () =>
        set((state) => ({
          screeningProgress: state.screeningProgress
            ? {
                ...state.screeningProgress,
                completedCount: state.screeningProgress.completedCount + 1,
              }
            : null,
        })),
      stopScreening: () =>
        set({
          screeningProgress: null,
          isScreening: false,
          stopRequested: false,
        }),
      stopRequested: false,
      requestStop: () => set({ stopRequested: true }),

      // UI state
      selectedSymbol: DEFAULT_SETTINGS.symbols[0],
      setSelectedSymbol: (symbol) => set({ selectedSymbol: symbol }),
      selectedView: 'Summary',
      setSelectedView: (view) => set({ selectedView: view }),
      isScreening: false,
      setIsScreening: (screening) => set({ isScreening: screening }),
      usedYahooFallback: false,
      setUsedYahooFallback: (used) => set({ usedYahooFallback: used }),

      // Sidebar
      sidebarOpen: true,
      setSidebarOpen: (open) => set({ sidebarOpen: open }),
      toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
    }),
    {
      name: 'put-options-screener',
      partialize: (state) => ({
        settings: state.settings,
        sidebarOpen: state.sidebarOpen,
      }),
    }
  )
);
