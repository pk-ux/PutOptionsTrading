/**
 * Admin page for managing system filters and trade ideas
 * - Portions generated by AI
 */

import { useEffect, useState, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Plus, Star, Trash2, Edit2 } from 'lucide-react';
import apiClient from '@/api/client';
import { Modal } from '@/components/Modal';
import { FilterForm } from '@/components/FilterForm';
import { TradeIdeaForm } from '@/components/TradeIdeaForm';
import { useAuthSync } from '@/hooks/useAuthSync';
import type { Filter, TradeIdea, FilterCreateRequest, TradeIdeaCreateRequest } from '@/types';

export function Admin() {
  const navigate = useNavigate();
  
  // Set up auth token getter
  const { isReady } = useAuthSync();

  // State
  const [systemFilters, setSystemFilters] = useState<Filter[]>([]);
  const [systemTradeIdeas, setSystemTradeIdeas] = useState<TradeIdea[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Modal state
  const [filterModalOpen, setFilterModalOpen] = useState(false);
  const [tradeIdeaModalOpen, setTradeIdeaModalOpen] = useState(false);
  const [editingFilter, setEditingFilter] = useState<Filter | null>(null);
  const [editingTradeIdea, setEditingTradeIdea] = useState<TradeIdea | null>(null);
  const [formLoading, setFormLoading] = useState(false);

  // Load data
  const loadData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const [filtersRes, ideasRes] = await Promise.all([
        apiClient.getFilters(),
        apiClient.getTradeIdeas(),
      ]);
      setSystemFilters(filtersRes.system_filters);
      setSystemTradeIdeas(ideasRes.system_trade_ideas);
    } catch (err: any) {
      console.error('Failed to load admin data:', err);
      if (err.response?.status === 403) {
        setError('Access denied. Admin privileges required.');
      } else {
        setError('Failed to load data. Please try again.');
      }
    } finally {
      setLoading(false);
    }
  }, []);

  // Wait for auth to be ready before loading data
  useEffect(() => {
    if (isReady) {
      loadData();
    }
  }, [loadData, isReady]);

  // Filter handlers
  const handleCreateFilter = () => {
    setEditingFilter(null);
    setFilterModalOpen(true);
  };

  const handleEditFilter = (filter: Filter) => {
    setEditingFilter(filter);
    setFilterModalOpen(true);
  };

  const handleSaveFilter = async (data: FilterCreateRequest) => {
    setFormLoading(true);
    try {
      if (editingFilter) {
        const updated = await apiClient.updateSystemFilter(editingFilter.id, data);
        setSystemFilters((prev) =>
          prev.map((f) => (f.id === updated.id ? updated : f))
        );
      } else {
        const created = await apiClient.createSystemFilter(data);
        setSystemFilters((prev) => [...prev, created]);
      }
      setFilterModalOpen(false);
      setEditingFilter(null);
    } catch (err) {
      console.error('Failed to save filter:', err);
      alert('Failed to save filter');
    } finally {
      setFormLoading(false);
    }
  };

  const handleSetDefaultFilter = async (filter: Filter) => {
    try {
      const updated = await apiClient.setDefaultFilter(filter.id);
      setSystemFilters((prev) =>
        prev.map((f) => ({
          ...f,
          is_default: f.id === updated.id,
        }))
      );
    } catch (err) {
      console.error('Failed to set default filter:', err);
      alert('Failed to set default filter');
    }
  };

  const handleDeleteFilter = async (filter: Filter) => {
    try {
      await apiClient.deleteSystemFilter(filter.id);
      setSystemFilters((prev) => prev.filter((f) => f.id !== filter.id));
    } catch (err: any) {
      console.error('Failed to delete filter:', err);
      alert(err.response?.data?.detail || 'Failed to delete filter');
    }
  };

  // Trade Idea handlers
  const handleCreateTradeIdea = () => {
    setEditingTradeIdea(null);
    setTradeIdeaModalOpen(true);
  };

  const handleEditTradeIdea = (idea: TradeIdea) => {
    setEditingTradeIdea(idea);
    setTradeIdeaModalOpen(true);
  };

  const handleSaveTradeIdea = async (data: TradeIdeaCreateRequest) => {
    setFormLoading(true);
    try {
      if (editingTradeIdea) {
        const updated = await apiClient.updateSystemTradeIdea(editingTradeIdea.id, data);
        setSystemTradeIdeas((prev) =>
          prev.map((i) => (i.id === updated.id ? updated : i))
        );
      } else {
        const created = await apiClient.createSystemTradeIdea(data);
        setSystemTradeIdeas((prev) => [...prev, created]);
      }
      setTradeIdeaModalOpen(false);
      setEditingTradeIdea(null);
    } catch (err) {
      console.error('Failed to save trade idea:', err);
      alert('Failed to save trade idea');
    } finally {
      setFormLoading(false);
    }
  };

  const handleSetDefaultTradeIdea = async (idea: TradeIdea) => {
    try {
      const updated = await apiClient.setDefaultTradeIdea(idea.id);
      setSystemTradeIdeas((prev) =>
        prev.map((i) => ({
          ...i,
          is_default: i.id === updated.id,
        }))
      );
    } catch (err) {
      console.error('Failed to set default trade idea:', err);
      alert('Failed to set default trade idea');
    }
  };

  const handleDeleteTradeIdea = async (idea: TradeIdea) => {
    try {
      await apiClient.deleteSystemTradeIdea(idea.id);
      setSystemTradeIdeas((prev) => prev.filter((i) => i.id !== idea.id));
    } catch (err: any) {
      console.error('Failed to delete trade idea:', err);
      alert(err.response?.data?.detail || 'Failed to delete trade idea');
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="flex items-center gap-3 text-gray-400">
          <svg className="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
          </svg>
          <span>Loading admin data...</span>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center gap-4">
        <p className="text-red-500">{error}</p>
        <button
          onClick={() => navigate('/')}
          className="btn-primary flex items-center gap-2"
        >
          <ArrowLeft size={18} />
          Back to App
        </button>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-4 sm:p-6 lg:p-8">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl sm:text-3xl font-bold text-white">Admin Dashboard</h1>
          <p className="text-gray-400 mt-1">Manage system filters and trade ideas</p>
        </div>
        <button
          onClick={() => navigate('/')}
          className="btn-secondary flex items-center gap-2"
        >
          <ArrowLeft size={18} />
          Back to App
        </button>
      </div>

      {/* Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* System Filters */}
        <div className="card">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-semibold">System Filters</h2>
            <button
              onClick={handleCreateFilter}
              className="btn-primary flex items-center gap-2 text-sm py-2"
            >
              <Plus size={16} />
              Add Filter
            </button>
          </div>

          {systemFilters.length === 0 ? (
            <p className="text-gray-500 text-center py-8">No system filters yet</p>
          ) : (
            <div className="space-y-3">
              {systemFilters.map((filter) => (
                <div
                  key={filter.id}
                  className="flex items-start justify-between p-3 bg-dark-800 rounded-lg border border-white/5"
                >
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      {filter.is_default && (
                        <Star size={14} className="text-yellow-400 fill-yellow-400" />
                      )}
                      <span className="font-medium text-white truncate">
                        {filter.name}
                      </span>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">
                      DTE: {filter.min_dte}-{filter.max_dte} | Vol: {filter.min_volume} |
                      OI: {filter.min_open_interest} | Ret: {filter.min_annualized_return}% |
                      Prob: {filter.max_assignment_probability}%
                    </p>
                  </div>
                  <div className="flex items-center gap-1 ml-2">
                    <button
                      onClick={() => handleEditFilter(filter)}
                      className="p-2 hover:bg-white/10 rounded transition-colors"
                      title="Edit"
                    >
                      <Edit2 size={14} className="text-gray-400" />
                    </button>
                    {!filter.is_default && (
                      <>
                        <button
                          onClick={() => handleSetDefaultFilter(filter)}
                          className="p-2 hover:bg-white/10 rounded transition-colors"
                          title="Set as Default"
                        >
                          <Star size={14} className="text-gray-400" />
                        </button>
                        <button
                          onClick={() => handleDeleteFilter(filter)}
                          className="p-2 hover:bg-red-500/20 rounded transition-colors"
                          title="Delete"
                        >
                          <Trash2 size={14} className="text-red-400" />
                        </button>
                      </>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* System Trade Ideas */}
        <div className="card">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-semibold">System Trade Ideas</h2>
            <button
              onClick={handleCreateTradeIdea}
              className="btn-primary flex items-center gap-2 text-sm py-2"
            >
              <Plus size={16} />
              Add Trade Idea
            </button>
          </div>

          {systemTradeIdeas.length === 0 ? (
            <p className="text-gray-500 text-center py-8">No system trade ideas yet</p>
          ) : (
            <div className="space-y-3">
              {systemTradeIdeas.map((idea) => (
                <div
                  key={idea.id}
                  className="flex items-start justify-between p-3 bg-dark-800 rounded-lg border border-white/5"
                >
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      {idea.is_default && (
                        <Star size={14} className="text-yellow-400 fill-yellow-400" />
                      )}
                      <span className="font-medium text-white truncate">
                        {idea.name}
                      </span>
                    </div>
                    {idea.description && (
                      <p className="text-xs text-gray-400 mt-0.5">{idea.description}</p>
                    )}
                    <p className="text-xs text-gray-500 mt-1">
                      {idea.symbols.slice(0, 5).join(', ')}
                      {idea.symbols.length > 5 && ` +${idea.symbols.length - 5} more`}
                    </p>
                  </div>
                  <div className="flex items-center gap-1 ml-2">
                    <button
                      onClick={() => handleEditTradeIdea(idea)}
                      className="p-2 hover:bg-white/10 rounded transition-colors"
                      title="Edit"
                    >
                      <Edit2 size={14} className="text-gray-400" />
                    </button>
                    {!idea.is_default && (
                      <>
                        <button
                          onClick={() => handleSetDefaultTradeIdea(idea)}
                          className="p-2 hover:bg-white/10 rounded transition-colors"
                          title="Set as Default"
                        >
                          <Star size={14} className="text-gray-400" />
                        </button>
                        <button
                          onClick={() => handleDeleteTradeIdea(idea)}
                          className="p-2 hover:bg-red-500/20 rounded transition-colors"
                          title="Delete"
                        >
                          <Trash2 size={14} className="text-red-400" />
                        </button>
                      </>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Filter Modal */}
      <Modal
        isOpen={filterModalOpen}
        onClose={() => {
          setFilterModalOpen(false);
          setEditingFilter(null);
        }}
        maxWidth="md"
      >
        <FilterForm
          filter={editingFilter}
          onSave={handleSaveFilter}
          onCancel={() => {
            setFilterModalOpen(false);
            setEditingFilter(null);
          }}
          loading={formLoading}
        />
      </Modal>

      {/* Trade Idea Modal */}
      <Modal
        isOpen={tradeIdeaModalOpen}
        onClose={() => {
          setTradeIdeaModalOpen(false);
          setEditingTradeIdea(null);
        }}
        maxWidth="md"
      >
        <TradeIdeaForm
          idea={editingTradeIdea}
          onSave={handleSaveTradeIdea}
          onCancel={() => {
            setTradeIdeaModalOpen(false);
            setEditingTradeIdea(null);
          }}
          loading={formLoading}
        />
      </Modal>
    </div>
  );
}

export default Admin;
