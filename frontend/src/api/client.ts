/**
 * API client for Put Options Screener
 * - Portions generated by AI
 */

import axios, { AxiosInstance } from 'axios';
import type { 
  UserSettings, 
  UserInfo, 
  ScreenRequest, 
  ScreenResponse, 
  NewsResponse,
  HealthResponse 
} from '@/types';

// Get API base URL from environment or default to relative path
const API_BASE_URL = import.meta.env.VITE_API_URL || '';

// Create axios instance
const api: AxiosInstance = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Token getter function - will be set by useAuthToken hook
let getAuthToken: (() => Promise<string | null>) | null = null;

export function setAuthTokenGetter(getter: () => Promise<string | null>) {
  getAuthToken = getter;
}

// Add auth token to requests
api.interceptors.request.use(async (config) => {
  // Try to get token from Clerk via the getter
  if (getAuthToken) {
    try {
      const token = await getAuthToken();
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
        return config;
      }
    } catch (e) {
      console.error('Error getting auth token:', e);
    }
  }
  
  // Fallback to localStorage (for dev mode)
  const localToken = localStorage.getItem('auth_token');
  if (localToken) {
    config.headers.Authorization = `Bearer ${localToken}`;
  }
  return config;
});

// API functions
export const apiClient = {
  // Health check
  async getHealth(): Promise<HealthResponse> {
    const response = await api.get('/health');
    return response.data;
  },

  // Get current user info (Phase 2)
  async getMe(): Promise<UserInfo> {
    const response = await api.get('/api/v1/me');
    return response.data;
  },

  // Get user settings
  async getSettings(): Promise<UserSettings> {
    const response = await api.get('/api/v1/settings');
    return response.data;
  },

  // Update user settings
  async updateSettings(settings: Partial<UserSettings>): Promise<UserSettings> {
    const response = await api.put('/api/v1/settings', settings);
    return response.data;
  },

  // Screen options
  async screenOptions(request: ScreenRequest): Promise<ScreenResponse> {
    const response = await api.post('/api/v1/screen', request);
    return response.data;
  },

  // Get news for symbol
  async getNews(symbol: string, limit = 10, maxAgeDays = 7): Promise<NewsResponse> {
    const response = await api.get(`/api/v1/news/${symbol}`, {
      params: { limit, max_age_days: maxAgeDays },
    });
    return response.data;
  },

  // Test screen (no auth required)
  async testScreen(symbol: string): Promise<unknown> {
    const response = await api.get('/api/v1/test-screen', {
      params: { symbol },
    });
    return response.data;
  },
};

export default apiClient;
