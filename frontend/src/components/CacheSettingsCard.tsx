/**
 * CacheSettingsCard component for admin cache configuration
 * - Portions generated by AI
 */

import { useState, useEffect, useCallback } from 'react';
import { Database, Save, RefreshCw } from 'lucide-react';
import apiClient from '@/api/client';
import type { CacheSettings } from '@/types';

interface CacheSettingsCardProps {
  isReady: boolean;
}

export function CacheSettingsCard({ isReady }: CacheSettingsCardProps) {
  const [settings, setSettings] = useState<CacheSettings | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  // Form state
  const [cacheEnabled, setCacheEnabled] = useState(true);
  const [ttlStockPrice, setTtlStockPrice] = useState(180);
  const [ttlOptionsChain, setTtlOptionsChain] = useState(300);
  const [ttlNews, setTtlNews] = useState(900);

  // Load settings
  useEffect(() => {
    if (!isReady) return;

    const loadSettings = async () => {
      setLoading(true);
      setError(null);
      try {
        const data = await apiClient.getCacheSettings();
        setSettings(data);
        setCacheEnabled(data.cache_enabled);
        setTtlStockPrice(data.ttl_stock_price);
        setTtlOptionsChain(data.ttl_options_chain);
        setTtlNews(data.ttl_news);
      } catch (err: any) {
        console.error('Failed to load cache settings:', err);
        setError('Failed to load cache settings');
      } finally {
        setLoading(false);
      }
    };

    loadSettings();
  }, [isReady]);

  // Save settings
  const handleSave = useCallback(async () => {
    setSaving(true);
    setError(null);
    setSuccess(false);

    try {
      const updated = await apiClient.updateCacheSettings({
        cache_enabled: cacheEnabled,
        ttl_stock_price: ttlStockPrice,
        ttl_options_chain: ttlOptionsChain,
        ttl_news: ttlNews,
      });
      setSettings(updated);
      setSuccess(true);
      setTimeout(() => setSuccess(false), 3000);
    } catch (err: any) {
      console.error('Failed to save cache settings:', err);
      setError('Failed to save cache settings');
    } finally {
      setSaving(false);
    }
  }, [cacheEnabled, ttlStockPrice, ttlOptionsChain, ttlNews]);

  // Check if form has changes
  const hasChanges =
    settings &&
    (cacheEnabled !== settings.cache_enabled ||
      ttlStockPrice !== settings.ttl_stock_price ||
      ttlOptionsChain !== settings.ttl_options_chain ||
      ttlNews !== settings.ttl_news);

  // Convert seconds to minutes for display
  const secondsToMinutes = (seconds: number) => Math.round(seconds / 60);
  const minutesToSeconds = (minutes: number) => minutes * 60;

  if (loading) {
    return (
      <div className="card">
        <div className="flex items-center gap-2 mb-4">
          <Database size={20} className="text-primary-400" />
          <h2 className="text-xl font-semibold">Cache Settings</h2>
        </div>
        <div className="flex items-center justify-center py-8 text-gray-400">
          <RefreshCw size={20} className="animate-spin mr-2" />
          Loading...
        </div>
      </div>
    );
  }

  return (
    <div className="card">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Database size={20} className="text-primary-400" />
          <h2 className="text-xl font-semibold">Cache Settings</h2>
        </div>
        {settings?.updated_at && (
          <span className="text-xs text-gray-500">
            Last updated: {new Date(settings.updated_at).toLocaleString()}
          </span>
        )}
      </div>

      {error && (
        <div className="mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
          {error}
        </div>
      )}

      {success && (
        <div className="mb-4 p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-green-400 text-sm">
          Cache settings saved successfully!
        </div>
      )}

      <div className="space-y-4">
        {/* Enable/Disable Toggle */}
        <div className="flex items-center justify-between p-3 bg-dark-800 rounded-lg">
          <div>
            <label className="font-medium text-white">Enable Caching</label>
            <p className="text-xs text-gray-500 mt-0.5">
              When disabled, all data is fetched fresh from APIs
            </p>
          </div>
          <button
            onClick={() => setCacheEnabled(!cacheEnabled)}
            className={`relative w-12 h-6 rounded-full transition-colors ${
              cacheEnabled ? 'bg-primary-500' : 'bg-gray-600'
            }`}
          >
            <span
              className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${
                cacheEnabled ? 'left-7' : 'left-1'
              }`}
            />
          </button>
        </div>

        {/* TTL Settings */}
        <div className={`space-y-3 ${!cacheEnabled ? 'opacity-50 pointer-events-none' : ''}`}>
          <div className="p-3 bg-dark-800 rounded-lg">
            <label className="block text-sm font-medium text-white mb-2">
              Stock Price TTL
            </label>
            <div className="flex items-center gap-3">
              <input
                type="number"
                min={1}
                max={60}
                value={secondsToMinutes(ttlStockPrice)}
                onChange={(e) => setTtlStockPrice(minutesToSeconds(parseInt(e.target.value) || 1))}
                className="w-20 px-3 py-2 bg-dark-700 border border-white/10 rounded-lg text-white text-center"
              />
              <span className="text-gray-400 text-sm">minutes</span>
              <span className="text-gray-500 text-xs ml-auto">
                ({ttlStockPrice} seconds)
              </span>
            </div>
          </div>

          <div className="p-3 bg-dark-800 rounded-lg">
            <label className="block text-sm font-medium text-white mb-2">
              Options Chain TTL
            </label>
            <div className="flex items-center gap-3">
              <input
                type="number"
                min={1}
                max={60}
                value={secondsToMinutes(ttlOptionsChain)}
                onChange={(e) => setTtlOptionsChain(minutesToSeconds(parseInt(e.target.value) || 1))}
                className="w-20 px-3 py-2 bg-dark-700 border border-white/10 rounded-lg text-white text-center"
              />
              <span className="text-gray-400 text-sm">minutes</span>
              <span className="text-gray-500 text-xs ml-auto">
                ({ttlOptionsChain} seconds)
              </span>
            </div>
          </div>

          <div className="p-3 bg-dark-800 rounded-lg">
            <label className="block text-sm font-medium text-white mb-2">
              News TTL
            </label>
            <div className="flex items-center gap-3">
              <input
                type="number"
                min={1}
                max={60}
                value={secondsToMinutes(ttlNews)}
                onChange={(e) => setTtlNews(minutesToSeconds(parseInt(e.target.value) || 1))}
                className="w-20 px-3 py-2 bg-dark-700 border border-white/10 rounded-lg text-white text-center"
              />
              <span className="text-gray-400 text-sm">minutes</span>
              <span className="text-gray-500 text-xs ml-auto">
                ({ttlNews} seconds)
              </span>
            </div>
          </div>
        </div>

        {/* Save Button */}
        <button
          onClick={handleSave}
          disabled={saving || !hasChanges}
          className={`w-full flex items-center justify-center gap-2 py-2.5 rounded-lg font-medium transition-colors ${
            hasChanges
              ? 'bg-primary-500 hover:bg-primary-600 text-white'
              : 'bg-gray-700 text-gray-400 cursor-not-allowed'
          }`}
        >
          {saving ? (
            <>
              <RefreshCw size={16} className="animate-spin" />
              Saving...
            </>
          ) : (
            <>
              <Save size={16} />
              Save Changes
            </>
          )}
        </button>
      </div>
    </div>
  );
}
