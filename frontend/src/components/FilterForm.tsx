/**
 * FilterForm component for creating and editing filters
 * - Portions generated by AI
 */

import React, { useState, useEffect } from 'react';
import type { Filter, FilterCreateRequest } from '@/types';

interface FilterFormProps {
  filter?: Filter | null;
  onSave: (data: FilterCreateRequest) => void;
  onCancel: () => void;
  loading?: boolean;
}

export function FilterForm({ filter, onSave, onCancel, loading }: FilterFormProps) {
  const [name, setName] = useState(filter?.name || '');
  const [minDte, setMinDte] = useState(filter?.min_dte ?? 15);
  const [maxDte, setMaxDte] = useState(filter?.max_dte ?? 45);
  const [minVolume, setMinVolume] = useState(filter?.min_volume ?? 10);
  const [minOpenInterest, setMinOpenInterest] = useState(filter?.min_open_interest ?? 10);
  const [minReturn, setMinReturn] = useState(filter?.min_annualized_return ?? 20);
  const [maxProb, setMaxProb] = useState(filter?.max_assignment_probability ?? 20);

  // Reset form when filter prop changes
  useEffect(() => {
    setName(filter?.name || '');
    setMinDte(filter?.min_dte ?? 15);
    setMaxDte(filter?.max_dte ?? 45);
    setMinVolume(filter?.min_volume ?? 10);
    setMinOpenInterest(filter?.min_open_interest ?? 10);
    setMinReturn(filter?.min_annualized_return ?? 20);
    setMaxProb(filter?.max_assignment_probability ?? 20);
  }, [filter]);

  // Auto-generate name from params if not set
  const autoGeneratedName = `DTE_${minDte}-${maxDte}_VOL_${minVolume}_OI_${minOpenInterest}_RET_${Math.round(minReturn)}_PROB_${maxProb}`;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSave({
      name: name.trim() || autoGeneratedName,
      min_dte: minDte,
      max_dte: maxDte,
      min_volume: minVolume,
      min_open_interest: minOpenInterest,
      min_annualized_return: minReturn,
      max_assignment_probability: maxProb,
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
        {filter ? 'Edit Filter' : 'Create New Filter'}
      </h3>

      {/* Name */}
      <div>
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
          Name (optional)
        </label>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder={autoGeneratedName}
          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                     bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                     focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <p className="text-xs text-gray-500 mt-1">
          Leave blank to auto-generate from parameters
        </p>
      </div>

      {/* DTE Range */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Min DTE
          </label>
          <input
            type="number"
            value={minDte}
            onChange={(e) => setMinDte(parseInt(e.target.value) || 0)}
            min={0}
            max={365}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Max DTE
          </label>
          <input
            type="number"
            value={maxDte}
            onChange={(e) => setMaxDte(parseInt(e.target.value) || 0)}
            min={0}
            max={365}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      {/* Volume and OI */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Min Volume
          </label>
          <input
            type="number"
            value={minVolume}
            onChange={(e) => setMinVolume(parseInt(e.target.value) || 0)}
            min={0}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Min Open Interest
          </label>
          <input
            type="number"
            value={minOpenInterest}
            onChange={(e) => setMinOpenInterest(parseInt(e.target.value) || 0)}
            min={0}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      {/* Return and Probability */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Min Return (%)
          </label>
          <input
            type="number"
            value={minReturn}
            onChange={(e) => setMinReturn(parseFloat(e.target.value) || 0)}
            min={0}
            max={1000}
            step={0.1}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Max Probability (%)
          </label>
          <input
            type="number"
            value={maxProb}
            onChange={(e) => setMaxProb(parseInt(e.target.value) || 0)}
            min={0}
            max={100}
            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
                       bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4">
        <button
          type="button"
          onClick={onCancel}
          disabled={loading}
          className="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700
                     rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          disabled={loading}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700
                     transition-colors disabled:opacity-50 disabled:cursor-not-allowed
                     flex items-center gap-2"
        >
          {loading && (
            <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
            </svg>
          )}
          {filter ? 'Update' : 'Create'}
        </button>
      </div>
    </form>
  );
}

export default FilterForm;
