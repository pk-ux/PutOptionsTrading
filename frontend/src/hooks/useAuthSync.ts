/**
 * Hook to sync authentication state and load user data
 * Simplified: Just handles auth setup and triggers data loading
 * - Portions generated by AI
 */

import { useEffect, useCallback, useState, useRef } from 'react';
import { useAuth, useUser } from '@clerk/clerk-react';
import { useAppStore } from '@/stores/useAppStore';
import { setAuthTokenGetter } from '@/api/client';
import apiClient from '@/api/client';

// Check if Clerk is configured
const CLERK_ENABLED = !!import.meta.env.VITE_CLERK_PUBLISHABLE_KEY;

export function useAuthSync() {
  // Only use Clerk hooks if enabled
  if (!CLERK_ENABLED) {
    return { isLoading: false, isReady: true };
  }

  return useAuthSyncWithClerk();
}

function useAuthSyncWithClerk() {
  const { getToken, isLoaded, isSignedIn } = useAuth();
  const { user } = useUser();
  const { 
    setFilters, 
    selectFilter, 
    setTradeIdeas, 
    selectTradeIdea,
    resetState,
  } = useAppStore();
  
  // Track if token getter is ready and if data has been loaded
  const [isTokenReady, setIsTokenReady] = useState(false);
  const [isDataLoaded, setIsDataLoaded] = useState(false);
  
  // Track if we've already loaded for this session to avoid duplicate loads
  const hasLoadedRef = useRef(false);
  // Track previous signed in state to detect logout
  const wasSignedInRef = useRef(false);

  // Set up the token getter for the API client FIRST
  useEffect(() => {
    if (isLoaded && isSignedIn) {
      console.log('[AuthSync] Setting up token getter...');
      setAuthTokenGetter(async () => {
        try {
          const token = await getToken();
          return token;
        } catch (e) {
          console.error('[AuthSync] Error getting token:', e);
          return null;
        }
      });
      // Mark token as ready after setting the getter
      setIsTokenReady(true);
      wasSignedInRef.current = true;
      console.log('[AuthSync] Token getter ready');
    } else if (isLoaded && !isSignedIn) {
      // Check if this is a logout (was signed in, now signed out)
      if (wasSignedInRef.current) {
        console.log('[AuthSync] User signed out, resetting state');
        resetState();
      }
      // Reset state
      setIsTokenReady(false);
      setIsDataLoaded(false);
      hasLoadedRef.current = false;
      wasSignedInRef.current = false;
    }
  }, [isLoaded, isSignedIn, getToken, resetState]);

  // Load user data (filters and trade ideas with selections)
  const loadUserData = useCallback(async () => {
    console.log('[AuthSync] Loading user data...');
    if (!isSignedIn) return;

    try {
      // Load filters, trade ideas, and user settings in parallel
      const [filtersResponse, tradeIdeasResponse, userSettings] = await Promise.all([
        apiClient.getFilters(),
        apiClient.getTradeIdeas(),
        apiClient.getSettings(),
      ]);

      console.log('[AuthSync] Filters loaded:', filtersResponse);
      console.log('[AuthSync] Trade ideas loaded:', tradeIdeasResponse);
      console.log('[AuthSync] User settings:', userSettings);

      // Set filters in store
      setFilters(
        filtersResponse.system_filters,
        filtersResponse.user_filters,
        filtersResponse.default_filter_id || null
      );

      // Set trade ideas in store
      setTradeIdeas(
        tradeIdeasResponse.system_trade_ideas,
        tradeIdeasResponse.user_trade_ideas,
        tradeIdeasResponse.default_trade_idea_id || null
      );

      // Select the user's saved filter (or default)
      const allFilters = [...filtersResponse.system_filters, ...filtersResponse.user_filters];
      let selectedFilterToUse = null;

      if (userSettings.selected_filter_id) {
        selectedFilterToUse = allFilters.find(f => f.id === userSettings.selected_filter_id);
      }
      if (!selectedFilterToUse) {
        // Fall back to default filter
        selectedFilterToUse = filtersResponse.system_filters.find(f => f.is_default) 
          || filtersResponse.system_filters[0];
      }
      if (selectedFilterToUse) {
        selectFilter(selectedFilterToUse);
        console.log('[AuthSync] Selected filter:', selectedFilterToUse.name);
      }

      // Select the user's saved trade idea (or default)
      const allTradeIdeas = [...tradeIdeasResponse.system_trade_ideas, ...tradeIdeasResponse.user_trade_ideas];
      let selectedTradeIdeaToUse = null;

      if (userSettings.selected_trade_idea_id) {
        selectedTradeIdeaToUse = allTradeIdeas.find(i => i.id === userSettings.selected_trade_idea_id);
      }
      if (!selectedTradeIdeaToUse) {
        // Fall back to default trade idea
        selectedTradeIdeaToUse = tradeIdeasResponse.system_trade_ideas.find(i => i.is_default)
          || tradeIdeasResponse.system_trade_ideas[0];
      }
      if (selectedTradeIdeaToUse) {
        selectTradeIdea(selectedTradeIdeaToUse);
        console.log('[AuthSync] Selected trade idea:', selectedTradeIdeaToUse.name);
      }

      setIsDataLoaded(true);
      console.log('[AuthSync] User data loaded successfully');
    } catch (error) {
      console.error('[AuthSync] Error loading user data:', error);
      setIsDataLoaded(true); // Mark as loaded to prevent retry loop
    }
  }, [isSignedIn, setFilters, setTradeIdeas, selectFilter, selectTradeIdea]);

  // Auto-load data AFTER token is ready
  useEffect(() => {
    if (isLoaded && isSignedIn && isTokenReady && !hasLoadedRef.current) {
      console.log('[AuthSync] Token ready, loading user data...');
      hasLoadedRef.current = true;
      loadUserData();
    }
  }, [isLoaded, isSignedIn, isTokenReady, loadUserData]);

  return {
    isLoading: !isLoaded,
    isReady: isLoaded && (!isSignedIn || isDataLoaded),
    user,
    isSignedIn,
  };
}
