/**
 * Hook to sync authentication and settings with backend
 * - Portions generated by AI
 */

import { useEffect, useCallback } from 'react';
import { useAuth, useUser } from '@clerk/clerk-react';
import { useAppStore } from '@/stores/useAppStore';
import { setAuthTokenGetter } from '@/api/client';
import apiClient from '@/api/client';

// Check if Clerk is configured
const CLERK_ENABLED = !!import.meta.env.VITE_CLERK_PUBLISHABLE_KEY;

export function useAuthSync() {
  // Only use Clerk hooks if enabled
  if (!CLERK_ENABLED) {
    return { isLoading: false, syncSettings: () => {} };
  }

  return useAuthSyncWithClerk();
}

function useAuthSyncWithClerk() {
  const { getToken, isLoaded, isSignedIn } = useAuth();
  const { user } = useUser();
  const { setSettings } = useAppStore();

  // Set up the token getter for the API client
  useEffect(() => {
    if (isLoaded) {
      setAuthTokenGetter(async () => {
        try {
          return await getToken();
        } catch {
          return null;
        }
      });
    }
  }, [isLoaded, getToken]);

  // Sync settings from backend when user signs in
  const syncSettings = useCallback(async () => {
    if (!isSignedIn) return;

    try {
      const settings = await apiClient.getSettings();
      setSettings(settings);
    } catch (error) {
      console.error('Error syncing settings from backend:', error);
      // Keep local settings if backend fetch fails
    }
  }, [isSignedIn, setSettings]);

  // Auto-sync when user signs in
  useEffect(() => {
    if (isLoaded && isSignedIn) {
      syncSettings();
    }
  }, [isLoaded, isSignedIn, syncSettings]);

  return {
    isLoading: !isLoaded,
    syncSettings,
    user,
    isSignedIn,
  };
}

/**
 * Hook to save settings to backend
 */
export function useSaveSettings() {
  const { isSignedIn } = CLERK_ENABLED ? useAuth() : { isSignedIn: false };
  const { settings } = useAppStore();

  const saveToBackend = useCallback(async () => {
    if (!CLERK_ENABLED || !isSignedIn) {
      // In dev mode, just save locally (already done by store)
      return true;
    }

    try {
      await apiClient.updateSettings(settings);
      return true;
    } catch (error) {
      console.error('Error saving settings to backend:', error);
      return false;
    }
  }, [isSignedIn, settings]);

  return { saveToBackend };
}
