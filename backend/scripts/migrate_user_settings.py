"""
Migrate existing user settings to Filter and TradeIdea system
- Portions generated by AI

Run this script after deploying the new schema to migrate existing user data:
    cd backend
    python -m scripts.migrate_user_settings

This script:
1. For each user with settings that haven't been migrated yet:
   - Creates a personal Filter from their current screening params
   - Creates a personal TradeIdea from their current symbols
   - Sets selected_filter_id and selected_trade_idea_id to the new items
2. The migration is idempotent - running it multiple times is safe
"""

import sys
import os
import uuid

# Add backend to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.core.database import SessionLocal, init_db
from app.models import UserSettings, Filter, TradeIdea


def migrate_user_settings(db) -> dict:
    """
    Migrate existing user settings to Filter and TradeIdea.
    Returns dict with migration statistics.
    """
    stats = {
        "users_checked": 0,
        "users_migrated": 0,
        "users_skipped": 0,
        "filters_created": 0,
        "trade_ideas_created": 0,
    }
    
    # Get all user settings
    all_settings = db.query(UserSettings).all()
    stats["users_checked"] = len(all_settings)
    
    for settings in all_settings:
        # Skip if already migrated (has selected_filter_id set)
        if settings.selected_filter_id is not None:
            stats["users_skipped"] += 1
            print(f"  User {settings.user_id}: already migrated, skipping")
            continue
        
        try:
            # Create a personal Filter from current params
            user_filter = Filter(
                id=str(uuid.uuid4()),
                name="My Settings (Migrated)",
                is_system=False,
                is_default=False,
                user_id=settings.user_id,
                min_dte=settings.min_dte or 15,
                max_dte=settings.max_dte or 45,
                min_volume=settings.min_volume or 10,
                min_open_interest=settings.min_open_interest or 10,
                min_annualized_return=settings.min_annualized_return or 20.0,
                max_assignment_probability=settings.max_assignment_probability or 20,
            )
            db.add(user_filter)
            stats["filters_created"] += 1
            
            # Create a personal TradeIdea from current symbols
            symbols = settings.symbols or "AAPL,MSFT,GOOGL,SPY,QQQ"
            user_idea = TradeIdea(
                id=str(uuid.uuid4()),
                name="My Watchlist (Migrated)",
                description="Migrated from previous settings",
                is_system=False,
                is_default=False,
                user_id=settings.user_id,
                symbols=symbols,
            )
            db.add(user_idea)
            stats["trade_ideas_created"] += 1
            
            # Flush to get IDs
            db.flush()
            
            # Link user settings to their migrated data
            settings.selected_filter_id = user_filter.id
            settings.selected_trade_idea_id = user_idea.id
            
            stats["users_migrated"] += 1
            print(f"  User {settings.user_id}: migrated successfully")
            
        except Exception as e:
            print(f"  User {settings.user_id}: ERROR - {e}")
            # Continue with other users even if one fails
            continue
    
    return stats


def main():
    """Main function to run migration"""
    print("Initializing database...")
    init_db()
    
    print("\nMigrating user settings to Filter/TradeIdea system...")
    print("=" * 60)
    
    db = SessionLocal()
    
    try:
        stats = migrate_user_settings(db)
        
        db.commit()
        
        print("\n" + "=" * 60)
        print("Migration complete!")
        print(f"  Users checked: {stats['users_checked']}")
        print(f"  Users migrated: {stats['users_migrated']}")
        print(f"  Users skipped (already migrated): {stats['users_skipped']}")
        print(f"  Filters created: {stats['filters_created']}")
        print(f"  Trade ideas created: {stats['trade_ideas_created']}")
        print("=" * 60)
        
    except Exception as e:
        print(f"\nError during migration: {e}")
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    main()
