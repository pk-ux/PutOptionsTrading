"""
Admin API endpoints for managing system filters and trade ideas
- Portions generated by AI
"""

from typing import List
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from ...core.database import get_db
from ...core.deps import get_current_admin, is_admin
from ...models import User, Filter, TradeIdea
from ...schemas.filter import FilterCreate, FilterUpdate, FilterResponse
from ...schemas.trade_idea import TradeIdeaCreate, TradeIdeaUpdate, TradeIdeaResponse

router = APIRouter()


# ============== System Filters ==============

def _filter_to_response(filter_obj: Filter) -> FilterResponse:
    """Convert Filter model to response schema"""
    return FilterResponse(
        id=filter_obj.id,
        name=filter_obj.name,
        is_system=filter_obj.is_system,
        is_default=filter_obj.is_default,
        user_id=filter_obj.user_id,
        min_dte=filter_obj.min_dte,
        max_dte=filter_obj.max_dte,
        min_volume=filter_obj.min_volume,
        min_open_interest=filter_obj.min_open_interest,
        min_annualized_return=filter_obj.min_annualized_return,
        max_assignment_probability=filter_obj.max_assignment_probability,
        created_at=filter_obj.created_at,
        updated_at=filter_obj.updated_at,
    )


@router.get("/filters", response_model=List[FilterResponse])
async def list_system_filters(
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """List all system filters (admin only)."""
    filters = db.query(Filter).filter(Filter.is_system == True).all()
    return [_filter_to_response(f) for f in filters]


@router.post("/filters", response_model=FilterResponse)
async def create_system_filter(
    filter_data: FilterCreate,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Create a new system filter (admin only)."""
    # Generate name if not provided
    name = filter_data.name
    if not name:
        name = Filter.generate_name(
            filter_data.min_dte,
            filter_data.max_dte,
            filter_data.min_volume,
            filter_data.min_open_interest,
            filter_data.min_annualized_return,
            filter_data.max_assignment_probability,
        )
    
    # Check if this is the first system filter (make it default)
    existing_system_filters = db.query(Filter).filter(Filter.is_system == True).count()
    is_default = existing_system_filters == 0
    
    new_filter = Filter(
        name=name,
        is_system=True,
        is_default=is_default,
        user_id=None,
        min_dte=filter_data.min_dte,
        max_dte=filter_data.max_dte,
        min_volume=filter_data.min_volume,
        min_open_interest=filter_data.min_open_interest,
        min_annualized_return=filter_data.min_annualized_return,
        max_assignment_probability=filter_data.max_assignment_probability,
    )
    
    db.add(new_filter)
    db.commit()
    db.refresh(new_filter)
    
    return _filter_to_response(new_filter)


@router.put("/filters/{filter_id}", response_model=FilterResponse)
async def update_system_filter(
    filter_id: str,
    filter_data: FilterUpdate,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Update a system filter (admin only)."""
    filter_obj = db.query(Filter).filter(
        Filter.id == filter_id,
        Filter.is_system == True
    ).first()
    
    if not filter_obj:
        raise HTTPException(status_code=404, detail="System filter not found")
    
    # Update fields
    update_data = filter_data.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        setattr(filter_obj, field, value)
    
    db.commit()
    db.refresh(filter_obj)
    
    return _filter_to_response(filter_obj)


@router.put("/filters/{filter_id}/set-default", response_model=FilterResponse)
async def set_default_system_filter(
    filter_id: str,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Set a system filter as the default (admin only)."""
    filter_obj = db.query(Filter).filter(
        Filter.id == filter_id,
        Filter.is_system == True
    ).first()
    
    if not filter_obj:
        raise HTTPException(status_code=404, detail="System filter not found")
    
    # Unset current default
    db.query(Filter).filter(
        Filter.is_system == True,
        Filter.is_default == True
    ).update({"is_default": False})
    
    # Set new default
    filter_obj.is_default = True
    db.commit()
    db.refresh(filter_obj)
    
    return _filter_to_response(filter_obj)


@router.delete("/filters/{filter_id}")
async def delete_system_filter(
    filter_id: str,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Delete a system filter (admin only). Cannot delete the default filter."""
    filter_obj = db.query(Filter).filter(
        Filter.id == filter_id,
        Filter.is_system == True
    ).first()
    
    if not filter_obj:
        raise HTTPException(status_code=404, detail="System filter not found")
    
    if filter_obj.is_default:
        raise HTTPException(
            status_code=400,
            detail="Cannot delete the default filter. Set another filter as default first."
        )
    
    db.delete(filter_obj)
    db.commit()
    
    return {"message": "System filter deleted successfully"}


# ============== System Trade Ideas ==============

def _trade_idea_to_response(idea: TradeIdea) -> TradeIdeaResponse:
    """Convert TradeIdea model to response schema"""
    return TradeIdeaResponse(
        id=idea.id,
        name=idea.name,
        description=idea.description,
        is_system=idea.is_system,
        is_default=idea.is_default,
        user_id=idea.user_id,
        symbols=idea.get_symbols_list(),
        created_at=idea.created_at,
        updated_at=idea.updated_at,
    )


@router.get("/trade-ideas", response_model=List[TradeIdeaResponse])
async def list_system_trade_ideas(
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """List all system trade ideas (admin only)."""
    ideas = db.query(TradeIdea).filter(TradeIdea.is_system == True).all()
    return [_trade_idea_to_response(i) for i in ideas]


@router.post("/trade-ideas", response_model=TradeIdeaResponse)
async def create_system_trade_idea(
    idea_data: TradeIdeaCreate,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Create a new system trade idea (admin only)."""
    # Check if this is the first system trade idea (make it default)
    existing_system_ideas = db.query(TradeIdea).filter(TradeIdea.is_system == True).count()
    is_default = existing_system_ideas == 0
    
    new_idea = TradeIdea(
        name=idea_data.name,
        description=idea_data.description,
        is_system=True,
        is_default=is_default,
        user_id=None,
        symbols=",".join(idea_data.symbols),
    )
    
    db.add(new_idea)
    db.commit()
    db.refresh(new_idea)
    
    return _trade_idea_to_response(new_idea)


@router.put("/trade-ideas/{idea_id}", response_model=TradeIdeaResponse)
async def update_system_trade_idea(
    idea_id: str,
    idea_data: TradeIdeaUpdate,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Update a system trade idea (admin only)."""
    idea = db.query(TradeIdea).filter(
        TradeIdea.id == idea_id,
        TradeIdea.is_system == True
    ).first()
    
    if not idea:
        raise HTTPException(status_code=404, detail="System trade idea not found")
    
    # Update fields
    update_data = idea_data.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        if field == "symbols" and value is not None:
            idea.symbols = ",".join(value)
        else:
            setattr(idea, field, value)
    
    db.commit()
    db.refresh(idea)
    
    return _trade_idea_to_response(idea)


@router.put("/trade-ideas/{idea_id}/set-default", response_model=TradeIdeaResponse)
async def set_default_system_trade_idea(
    idea_id: str,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Set a system trade idea as the default (admin only)."""
    idea = db.query(TradeIdea).filter(
        TradeIdea.id == idea_id,
        TradeIdea.is_system == True
    ).first()
    
    if not idea:
        raise HTTPException(status_code=404, detail="System trade idea not found")
    
    # Unset current default
    db.query(TradeIdea).filter(
        TradeIdea.is_system == True,
        TradeIdea.is_default == True
    ).update({"is_default": False})
    
    # Set new default
    idea.is_default = True
    db.commit()
    db.refresh(idea)
    
    return _trade_idea_to_response(idea)


@router.delete("/trade-ideas/{idea_id}")
async def delete_system_trade_idea(
    idea_id: str,
    admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """Delete a system trade idea (admin only). Cannot delete the default idea."""
    idea = db.query(TradeIdea).filter(
        TradeIdea.id == idea_id,
        TradeIdea.is_system == True
    ).first()
    
    if not idea:
        raise HTTPException(status_code=404, detail="System trade idea not found")
    
    if idea.is_default:
        raise HTTPException(
            status_code=400,
            detail="Cannot delete the default trade idea. Set another as default first."
        )
    
    db.delete(idea)
    db.commit()
    
    return {"message": "System trade idea deleted successfully"}
