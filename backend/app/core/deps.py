"""
FastAPI dependencies
- Portions generated by AI
"""

from typing import Optional, Dict, Any
from fastapi import Depends, HTTPException, Header
from sqlalchemy.orm import Session

from .database import get_db
from .config import get_settings
from ..models import User
from ..services.user import get_or_create_user

settings = get_settings()


async def get_current_user_optional(
    authorization: Optional[str] = Header(None),
    db: Session = Depends(get_db)
) -> Optional[User]:
    """
    Get current user if authenticated, None otherwise.
    Used for endpoints that work with or without auth.
    """
    if not authorization:
        return None
    
    if not authorization.startswith("Bearer "):
        return None
    
    token = authorization.replace("Bearer ", "")
    
    # Phase 1: Dev mode - accept any token and create/get dev user
    # Phase 2: Will integrate Clerk JWT verification
    if not settings.CLERK_SECRET_KEY:
        # Dev mode: use a mock user
        user = get_or_create_user(db, "dev_user_123", "dev@example.com")
        return user
    
    # TODO Phase 2: Implement Clerk JWT verification
    return None


async def get_current_user(
    authorization: str = Header(...),
    db: Session = Depends(get_db)
) -> User:
    """
    Get current authenticated user.
    Raises 401 if not authenticated.
    """
    if not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Invalid authorization format")
    
    token = authorization.replace("Bearer ", "")
    
    # Phase 1: Dev mode - accept any token
    if not settings.CLERK_SECRET_KEY:
        # Dev mode: use a mock user
        user = get_or_create_user(db, "dev_user_123", "dev@example.com")
        return user
    
    # TODO Phase 2: Implement Clerk JWT verification
    raise HTTPException(status_code=401, detail="Authentication not configured")


def get_settings_dep():
    """Dependency to get settings"""
    return get_settings()
