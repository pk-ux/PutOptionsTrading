"""
Tests for Filter API endpoints
- Portions generated by AI
"""

import pytest
from fastapi.testclient import TestClient


class TestFiltersAPI:
    """Tests for the filters API"""

    def test_list_filters_empty(self, client: TestClient):
        """Test listing filters when none exist"""
        response = client.get("/api/v1/filters")
        assert response.status_code == 200
        data = response.json()
        assert "system_filters" in data
        assert "user_filters" in data
        assert data["system_filters"] == []
        assert data["user_filters"] == []

    def test_create_user_filter(self, client: TestClient, auth_headers):
        """Test creating a user filter"""
        filter_data = {
            "name": "Test Filter",
            "min_dte": 10,
            "max_dte": 30,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 25.0,
            "max_assignment_probability": 15,
        }
        response = client.post(
            "/api/v1/filters",
            json=filter_data,
            headers=auth_headers,
        )
        assert response.status_code == 200
        data = response.json()
        assert data["name"] == "Test Filter"
        assert data["is_system"] == False
        assert data["min_dte"] == 10
        assert data["max_dte"] == 30

    def test_create_filter_auto_name(self, client: TestClient, auth_headers):
        """Test creating a filter with auto-generated name"""
        filter_data = {
            "min_dte": 15,
            "max_dte": 45,
            "min_volume": 10,
            "min_open_interest": 10,
            "min_annualized_return": 20.0,
            "max_assignment_probability": 20,
        }
        response = client.post(
            "/api/v1/filters",
            json=filter_data,
            headers=auth_headers,
        )
        assert response.status_code == 200
        data = response.json()
        # Name should be auto-generated
        assert "DTE_15-45" in data["name"]

    def test_create_filter_limit(self, client: TestClient, auth_headers):
        """Test that user cannot create more than 10 filters"""
        # Create 10 filters
        for i in range(10):
            filter_data = {
                "name": f"Filter {i}",
                "min_dte": 10,
                "max_dte": 30,
                "min_volume": 50,
                "min_open_interest": 50,
                "min_annualized_return": 25.0,
                "max_assignment_probability": 15,
            }
            response = client.post(
                "/api/v1/filters",
                json=filter_data,
                headers=auth_headers,
            )
            assert response.status_code == 200

        # 11th filter should fail
        filter_data = {
            "name": "Filter 10",
            "min_dte": 10,
            "max_dte": 30,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 25.0,
            "max_assignment_probability": 15,
        }
        response = client.post(
            "/api/v1/filters",
            json=filter_data,
            headers=auth_headers,
        )
        assert response.status_code == 400
        assert "Maximum of 10" in response.json()["detail"]

    def test_update_user_filter(self, client: TestClient, auth_headers):
        """Test updating a user filter"""
        # Create filter
        filter_data = {
            "name": "Original Name",
            "min_dte": 10,
            "max_dte": 30,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 25.0,
            "max_assignment_probability": 15,
        }
        create_response = client.post(
            "/api/v1/filters",
            json=filter_data,
            headers=auth_headers,
        )
        filter_id = create_response.json()["id"]

        # Update filter
        update_data = {"name": "Updated Name", "min_dte": 20}
        update_response = client.put(
            f"/api/v1/filters/{filter_id}",
            json=update_data,
            headers=auth_headers,
        )
        assert update_response.status_code == 200
        data = update_response.json()
        assert data["name"] == "Updated Name"
        assert data["min_dte"] == 20
        assert data["max_dte"] == 30  # Unchanged

    def test_delete_user_filter(self, client: TestClient, auth_headers):
        """Test deleting a user filter"""
        # Create filter
        filter_data = {
            "name": "To Delete",
            "min_dte": 10,
            "max_dte": 30,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 25.0,
            "max_assignment_probability": 15,
        }
        create_response = client.post(
            "/api/v1/filters",
            json=filter_data,
            headers=auth_headers,
        )
        filter_id = create_response.json()["id"]

        # Delete filter
        delete_response = client.delete(
            f"/api/v1/filters/{filter_id}",
            headers=auth_headers,
        )
        assert delete_response.status_code == 200

        # Verify deleted
        get_response = client.get(
            f"/api/v1/filters/{filter_id}",
            headers=auth_headers,
        )
        assert get_response.status_code == 404

    def test_get_filter_not_found(self, client: TestClient):
        """Test getting a non-existent filter"""
        response = client.get("/api/v1/filters/nonexistent-id")
        assert response.status_code == 404
