"""
Tests for Admin API endpoints
- Portions generated by AI
"""

import pytest
from fastapi.testclient import TestClient


class TestAdminAPI:
    """Tests for the admin API"""

    def test_create_system_filter(self, client: TestClient, auth_headers):
        """Test creating a system filter (admin only)"""
        filter_data = {
            "name": "System Filter",
            "min_dte": 15,
            "max_dte": 45,
            "min_volume": 10,
            "min_open_interest": 10,
            "min_annualized_return": 20.0,
            "max_assignment_probability": 20,
        }
        response = client.post(
            "/api/v1/admin/filters",
            json=filter_data,
            headers=auth_headers,
        )
        # In dev mode without CLERK_SECRET_KEY, dev user is treated as admin
        assert response.status_code == 200
        data = response.json()
        assert data["name"] == "System Filter"
        assert data["is_system"] == True
        # First system filter should be default
        assert data["is_default"] == True

    def test_create_second_system_filter_not_default(self, client: TestClient, auth_headers):
        """Test that second system filter is not default"""
        # Create first filter
        filter1 = {
            "name": "First",
            "min_dte": 15,
            "max_dte": 45,
            "min_volume": 10,
            "min_open_interest": 10,
            "min_annualized_return": 20.0,
            "max_assignment_probability": 20,
        }
        response1 = client.post(
            "/api/v1/admin/filters",
            json=filter1,
            headers=auth_headers,
        )
        assert response1.json()["is_default"] == True

        # Create second filter
        filter2 = {
            "name": "Second",
            "min_dte": 7,
            "max_dte": 21,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 30.0,
            "max_assignment_probability": 15,
        }
        response2 = client.post(
            "/api/v1/admin/filters",
            json=filter2,
            headers=auth_headers,
        )
        assert response2.json()["is_default"] == False

    def test_set_default_filter(self, client: TestClient, auth_headers):
        """Test setting a different filter as default"""
        # Create two filters
        filter1 = {
            "name": "First",
            "min_dte": 15,
            "max_dte": 45,
            "min_volume": 10,
            "min_open_interest": 10,
            "min_annualized_return": 20.0,
            "max_assignment_probability": 20,
        }
        filter2 = {
            "name": "Second",
            "min_dte": 7,
            "max_dte": 21,
            "min_volume": 50,
            "min_open_interest": 50,
            "min_annualized_return": 30.0,
            "max_assignment_probability": 15,
        }
        
        response1 = client.post("/api/v1/admin/filters", json=filter1, headers=auth_headers)
        response2 = client.post("/api/v1/admin/filters", json=filter2, headers=auth_headers)
        
        filter2_id = response2.json()["id"]
        
        # Set second filter as default
        set_default_response = client.put(
            f"/api/v1/admin/filters/{filter2_id}/set-default",
            headers=auth_headers,
        )
        assert set_default_response.status_code == 200
        assert set_default_response.json()["is_default"] == True

    def test_cannot_delete_default_filter(self, client: TestClient, auth_headers):
        """Test that default filter cannot be deleted"""
        # Create a filter (will be default)
        filter_data = {
            "name": "Default Filter",
            "min_dte": 15,
            "max_dte": 45,
            "min_volume": 10,
            "min_open_interest": 10,
            "min_annualized_return": 20.0,
            "max_assignment_probability": 20,
        }
        response = client.post(
            "/api/v1/admin/filters",
            json=filter_data,
            headers=auth_headers,
        )
        filter_id = response.json()["id"]

        # Try to delete default filter
        delete_response = client.delete(
            f"/api/v1/admin/filters/{filter_id}",
            headers=auth_headers,
        )
        assert delete_response.status_code == 400
        assert "Cannot delete the default filter" in delete_response.json()["detail"]

    def test_create_system_trade_idea(self, client: TestClient, auth_headers):
        """Test creating a system trade idea (admin only)"""
        idea_data = {
            "name": "System Idea",
            "description": "A system trade idea",
            "symbols": ["AAPL", "MSFT", "GOOGL"],
        }
        response = client.post(
            "/api/v1/admin/trade-ideas",
            json=idea_data,
            headers=auth_headers,
        )
        assert response.status_code == 200
        data = response.json()
        assert data["name"] == "System Idea"
        assert data["is_system"] == True
        # First system trade idea should be default
        assert data["is_default"] == True

    def test_cannot_delete_default_trade_idea(self, client: TestClient, auth_headers):
        """Test that default trade idea cannot be deleted"""
        # Create a trade idea (will be default)
        idea_data = {
            "name": "Default Idea",
            "symbols": ["AAPL"],
        }
        response = client.post(
            "/api/v1/admin/trade-ideas",
            json=idea_data,
            headers=auth_headers,
        )
        idea_id = response.json()["id"]

        # Try to delete default trade idea
        delete_response = client.delete(
            f"/api/v1/admin/trade-ideas/{idea_id}",
            headers=auth_headers,
        )
        assert delete_response.status_code == 400
        assert "Cannot delete the default trade idea" in delete_response.json()["detail"]
